{"ast":null,"code":"import _classCallCheck from \"/Users/ivan/Metadata/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/ivan/Metadata/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport { Connection } from \"./core/connection.js\";\nimport { DEFAULT_POPUP_HEIGHT_PX, DEFAULT_POPUP_WIDTH_PX } from \"./core/constants.js\";\nimport { PopupEvent } from \"./core/types.js\";\nimport { openPopup, validateOrigin } from \"./core/utils.js\";\nexport var ConnectionManager = /*#__PURE__*/function () {\n  function ConnectionManager(platform) {\n    var _this = this;\n    _classCallCheck(this, ConnectionManager);\n    this.platform = platform;\n    this.connection = null;\n    this.popupWindow = null;\n    this.handleMessage = function (e) {\n      var _a, _b;\n      if (!validateOrigin(e.origin)) {\n        return;\n      }\n      var validatedOrigin = e.origin;\n      if (!_this.popupWindow) {\n        return;\n      }\n      if (e.data.event === PopupEvent.HANDSHAKE && !_this.connection) {\n        if (!_this.verifyAndResetNonce((_a = e.data.payload) === null || _a === void 0 ? void 0 : _a.nonce)) {\n          return;\n        }\n        _this.popupWindow.postMessage({\n          event: PopupEvent.HANDSHAKE_ACK,\n          payload: {\n            platform: _this.platform\n          }\n        }, validatedOrigin);\n        _this.connection = new Connection(validatedOrigin, _this.popupWindow);\n        (_b = _this.connectionUpdatedCallback) === null || _b === void 0 ? void 0 : _b.call(_this, _this.connection);\n      }\n      if (!_this.connection) {\n        return;\n      }\n      _this.connection.runHandlersForEvent(e.data.event, e.data.payload);\n      if (e.data.event === PopupEvent.POPUP_CLOSED && _this.connection) {\n        _this.resetConnection();\n        _this.popupWindow = null;\n      }\n    };\n  }\n  _createClass(ConnectionManager, [{\n    key: \"initialize\",\n    value: function initialize() {\n      window.addEventListener('message', this.handleMessage);\n      return this;\n    }\n  }, {\n    key: \"tearDown\",\n    value: function tearDown() {\n      window.removeEventListener('message', this.handleMessage);\n      this.resetConnection();\n      return this;\n    }\n  }, {\n    key: \"open\",\n    value: function open(_ref) {\n      var url = _ref.url,\n        _ref$widthPx = _ref.widthPx,\n        widthPx = _ref$widthPx === void 0 ? DEFAULT_POPUP_WIDTH_PX : _ref$widthPx,\n        _ref$heightPx = _ref.heightPx,\n        heightPx = _ref$heightPx === void 0 ? DEFAULT_POPUP_HEIGHT_PX : _ref$heightPx,\n        nonce = _ref.nonce;\n      var _a;\n      if ((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.closed) {\n        this.resetConnectionAndPopupWindow();\n      }\n      if (this.popupWindow) {\n        return;\n      }\n      this.initialize();\n      if (nonce) {\n        this.nonce = nonce;\n      }\n      var left = window.screenX + (window.innerWidth - widthPx) / 2;\n      var top = window.screenY + (window.innerHeight - heightPx) / 2;\n      this.popupWindow = openPopup({\n        height: heightPx,\n        left: left,\n        top: top,\n        url: url,\n        width: widthPx\n      });\n    }\n  }, {\n    key: \"close\",\n    value: function close() {\n      if (!this.popupWindow) {\n        return;\n      }\n      this.popupWindow.close();\n      this.resetConnectionAndPopupWindow();\n    }\n  }, {\n    key: \"onConnectionUpdated\",\n    value: function onConnectionUpdated(callback) {\n      this.connectionUpdatedCallback = callback;\n      return this;\n    }\n  }, {\n    key: \"getConnection\",\n    value: function getConnection() {\n      return this.connection;\n    }\n  }, {\n    key: \"resetConnectionAndPopupWindow\",\n    value: function resetConnectionAndPopupWindow() {\n      this.resetConnection();\n      this.popupWindow = null;\n    }\n  }, {\n    key: \"resetConnection\",\n    value: function resetConnection() {\n      var _a, _b;\n      (_a = this.connection) === null || _a === void 0 ? void 0 : _a.resetHandlers();\n      this.connection = null;\n      (_b = this.connectionUpdatedCallback) === null || _b === void 0 ? void 0 : _b.call(this, this.connection);\n    }\n  }, {\n    key: \"verifyAndResetNonce\",\n    value: function verifyAndResetNonce(uncheckedNonce) {\n      if (!this.nonce) {\n        return true;\n      }\n      var result = uncheckedNonce === this.nonce;\n      if (result) {\n        this.nonce = undefined;\n      }\n      return result;\n    }\n  }]);\n  return ConnectionManager;\n}();","map":{"version":3,"mappings":";;AAAA,SAASA,UAAU,QAAE,sBAAwB;AAC7C,SACEC,uBAAuB,EACvBC,sBAAsB,QACvB,qBAAuB;AACxB,SAAmBC,UAAU,QAAE,iBAAmB;AAClD,SAASC,SAAS,EAAEC,cAAc,QAAE,iBAAmB;AASvD,WAAaC,iBAAiB;EAoD5B,2BAA6BC,QAAkB;IAAA;IAAA;IAAlB,aAAQ,GAARA,QAAQ;IAnD7B,eAAU,GAAsB,IAAI;IACpC,gBAAW,GAAkB,IAAI;IAIxB,kBAAa,GAAG,UAACC,CAAe,EAAI;;MAEnD,IAAI,CAACH,cAAc,CAACG,CAAC,CAACC,MAAM,CAAC,EAAE;QAC7B;;MAEF,IAAMC,eAAe,GAAGF,CAAC,CAACC,MAAM;MAEhC,IAAI,CAAC,KAAI,CAACE,WAAW,EAAE;QAErB;;MAGF,IAAIH,CAAC,CAACI,IAAI,CAACC,KAAK,KAAKV,UAAU,CAACW,SAAS,IAAI,CAAC,KAAI,CAACC,UAAU,EAAE;QAC7D,IAAI,CAAC,KAAI,CAACC,mBAAmB,CAAC,OAAC,CAACJ,IAAI,CAACK,OAAO,0CAAEC,KAAK,CAAC,EAAE;UACpD;;QAGF,KAAI,CAACP,WAAW,CAACQ,WAAW,CAC1B;UACEN,KAAK,EAAEV,UAAU,CAACiB,aAAa;UAC/BH,OAAO,EAAE;YACPV,QAAQ,EAAE,KAAI,CAACA;;SAElB,EACDG,eAAe,CAChB;QAED,KAAI,CAACK,UAAU,GAAG,IAAIf,UAAU,CAACU,eAAe,EAAE,KAAI,CAACC,WAAW,CAAC;QACnE,WAAI,CAACU,yBAAyB,sDAAG,KAAI,CAACN,UAAU,CAAC;;MAGnD,IAAI,CAAC,KAAI,CAACA,UAAU,EAAE;QACpB;;MAGF,KAAI,CAACA,UAAU,CAACO,mBAAmB,CAACd,CAAC,CAACI,IAAI,CAACC,KAAK,EAAEL,CAAC,CAACI,IAAI,CAACK,OAAO,CAAC;MAKjE,IAAIT,CAAC,CAACI,IAAI,CAACC,KAAK,KAAKV,UAAU,CAACoB,YAAY,IAAI,KAAI,CAACR,UAAU,EAAE;QAC/D,KAAI,CAACS,eAAe,EAAE;QACtB,KAAI,CAACb,WAAW,GAAG,IAAI;;IAE3B,CAAC;EAEiD;EAAC;IAAA;IAAA,OAEnD,sBAAU;MACRc,MAAM,CAACC,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAACC,aAAa,CAAC;MACtD,OAAO,IAAI;IACb;EAAC;IAAA;IAAA,OAED,oBAAQ;MACNF,MAAM,CAACG,mBAAmB,CAAC,SAAS,EAAE,IAAI,CAACD,aAAa,CAAC;MACzD,IAAI,CAACH,eAAe,EAAE;MACtB,OAAO,IAAI;IACb;EAAC;IAAA;IAAA,OAED,oBAK8B;MAAA,IAJ5BK,GAAG,QAAHA,GAAG;QAAA,oBACHC,OAAO;QAAPA,OAAO,6BAAG5B,sBAAsB;QAAA,qBAChC6B,QAAQ;QAARA,QAAQ,8BAAG9B,uBAAuB;QAClCiB,KAAK,QAALA,KAAK;;MAIL,IAAI,UAAI,CAACP,WAAW,0CAAEqB,MAAM,EAAE;QAC5B,IAAI,CAACC,6BAA6B,EAAE;;MAGtC,IAAI,IAAI,CAACtB,WAAW,EAAE;QACpB;;MAGF,IAAI,CAACuB,UAAU,EAAE;MAIjB,IAAIhB,KAAK,EAAE;QACT,IAAI,CAACA,KAAK,GAAGA,KAAK;;MAGpB,IAAMiB,IAAI,GAAGV,MAAM,CAACW,OAAO,GAAG,CAACX,MAAM,CAACY,UAAU,GAAGP,OAAO,IAAI,CAAC;MAC/D,IAAMQ,GAAG,GAAGb,MAAM,CAACc,OAAO,GAAG,CAACd,MAAM,CAACe,WAAW,GAAGT,QAAQ,IAAI,CAAC;MAChE,IAAI,CAACpB,WAAW,GAAGP,SAAS,CAAC;QAC3BqC,MAAM,EAAEV,QAAQ;QAChBI,IAAI,EAAJA,IAAI;QACJG,GAAG,EAAHA,GAAG;QACHT,GAAG,EAAHA,GAAG;QACHa,KAAK,EAAEZ;OACR,CAAC;IACJ;EAAC;IAAA;IAAA,OAED,iBAAK;MACH,IAAI,CAAC,IAAI,CAACnB,WAAW,EAAE;QACrB;;MAEF,IAAI,CAACA,WAAW,CAACgC,KAAK,EAAE;MACxB,IAAI,CAACV,6BAA6B,EAAE;IACtC;EAAC;IAAA;IAAA,OAED,6BAAoBW,QAAiD;MACnE,IAAI,CAACvB,yBAAyB,GAAGuB,QAAQ;MACzC,OAAO,IAAI;IACb;EAAC;IAAA;IAAA,OAED,yBAAa;MACX,OAAO,IAAI,CAAC7B,UAAU;IACxB;EAAC;IAAA;IAAA,OAEO,yCAA6B;MACnC,IAAI,CAACS,eAAe,EAAE;MACtB,IAAI,CAACb,WAAW,GAAG,IAAI;IACzB;EAAC;IAAA;IAAA,OAEO,2BAAe;;MACrB,UAAI,CAACI,UAAU,0CAAE8B,aAAa,EAAE;MAChC,IAAI,CAAC9B,UAAU,GAAG,IAAI;MACtB,UAAI,CAACM,yBAAyB,qDAAG,IAAI,CAACN,UAAU,CAAC;IACnD;EAAC;IAAA;IAAA,OAEO,6BAAoB+B,cAAuB;MACjD,IAAI,CAAC,IAAI,CAAC5B,KAAK,EAAE;QAEf,OAAO,IAAI;;MAWb,IAAM6B,MAAM,GAAGD,cAAc,KAAK,IAAI,CAAC5B,KAAK;MAI5C,IAAI6B,MAAM,EAAE;QACV,IAAI,CAAC7B,KAAK,GAAG8B,SAAS;;MAGxB,OAAOD,MAAM;IACf;EAAC;EAAA;AAAA","names":["Connection","DEFAULT_POPUP_HEIGHT_PX","DEFAULT_POPUP_WIDTH_PX","PopupEvent","openPopup","validateOrigin","ConnectionManager","platform","e","origin","validatedOrigin","popupWindow","data","event","HANDSHAKE","connection","verifyAndResetNonce","payload","nonce","postMessage","HANDSHAKE_ACK","connectionUpdatedCallback","runHandlersForEvent","POPUP_CLOSED","resetConnection","window","addEventListener","handleMessage","removeEventListener","url","widthPx","heightPx","closed","resetConnectionAndPopupWindow","initialize","left","screenX","innerWidth","top","screenY","innerHeight","height","width","close","callback","resetHandlers","uncheckedNonce","result","undefined"],"sources":["../../src/connection-manager.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module","externalDependencies":[]}